---
import Layout from '../../../layouts/Layout.astro';
import { getServiceAndSubServiceBySlugs, getAllServices, getAllCities } from '../../../lib/services';
import { getSEOProps, generateCanonicalUrl } from '../../../lib/seo';
import { ServiceGrid } from '../../../components/service-grid';
import { Breadcrumb } from '../../../components/semantic/breadcrumb';
import { Card, CardContent, CardDescription, CardHeader, CardTitle } from '../../../components/ui/card';
import { Badge } from '../../../components/ui/badge';
import { Check, Star, Clock, Shield } from 'lucide-react';
import { FAQ } from '../../../components/service/FAQ';
import { PricingCard } from '../../../components/service/PricingCard';
import { ProcessSteps } from '../../../components/service/ProcessSteps';
import { Testimonials } from '../../../components/service/Testimonials';
import { ServiceStats } from '../../../components/service/ServiceStats';
import { ServiceGallery } from '../../../components/service/ServiceGallery';
import { ServiceProviders } from '../../../components/service/ServiceProviders';
import { ServiceCTA } from '../../../components/service/ServiceCTA';
import { FAQSchema } from '../../../components/semantic/faq-schema';
import { CityServices } from '../../../components/service/CityServices';

export async function getStaticPaths() {
  const services = getAllServices();
  const paths = [];
  
  for (const service of services) {
    for (const subService of service.sub_services) {
      paths.push({
        params: { 
          service: service.slug,
          subservice: subService.slug 
        },
        props: { 
          service, 
          subService 
        },
      });
    }
  }
  
  return paths;
}

const { service, subService } = Astro.props;

if (!service || !subService) {
  return Astro.redirect('/404');
}

const seoProps = {
  title: `${subService.ar_name} | ${service.ar_name}`,
  description: subService.seo.summary,
  keywords: subService.seo.primary_keywords,
  canonical: generateCanonicalUrl(`/services/${service.slug}/${subService.slug}`)
};
---

<Layout {...seoProps}>
  <div class="container py-12 px-4 md:px-6">
    <div class="max-w-6xl mx-auto">
      <!-- Breadcrumb -->
      <Breadcrumb client:load />
      
      <!-- Service Header -->
      <div class="text-center mb-12">
        <div class="flex justify-center gap-2 mb-4">
          <Badge class="font-headline bg-primary/10 text-primary hover:bg-primary/20">
            {service.category}
          </Badge>
          <Badge variant="outline">
            {service.ar_name}
          </Badge>
        </div>
        <h1 class="font-headline text-4xl font-bold tracking-tighter sm:text-5xl md:text-6xl mb-4">
          {subService.ar_name}
        </h1>
        <p class="max-w-3xl mx-auto text-foreground/80 md:text-xl/relaxed">
          احصل على أفضل خدمات {subService.ar_name} من محترفين معتمدين ومتخصصين
        </p>
      </div>

      <!-- Service Overview -->
      <Card class="mb-12">
        <CardHeader>
          <CardTitle class="font-headline text-2xl">نظرة عامة على الخدمة</CardTitle>
        </CardHeader>
        <CardContent>
          <div class="prose prose-lg max-w-none">
            <p class="text-foreground/80 leading-relaxed mb-4">
              نقدم خدمات {subService.ar_name} المتخصصة بأعلى معايير الجودة والاحترافية. 
              فريقنا من المحترفين المعتمدين جاهز لتقديم أفضل الحلول لاحتياجاتك.
            </p>
            <p class="text-foreground/80 leading-relaxed">
              {subService.seo.summary}
            </p>
          </div>
        </CardContent>
      </Card>

      <!-- Pricing Card -->
      <div class="mb-12">
        <PricingCard
          title={subService.ar_name}
          priceRange={subService.avg_price_range}
          duration={2}
          features={[
            "فنيون معتمدون ومتخصصون",
            "أدوات ومعدات متطورة",
            "ضمان شامل على الخدمة",
            "دعم فني 24/7",
            "أسعار تنافسية"
          ]}
          isPopular={subService.urgency === 'emergency'}
          emergencyAvailable={subService.urgency === 'emergency'}
          seasonalMultiplier={subService.seasonal_multiplier}
          client:load
        />
      </div>

      <!-- Process Steps -->
      <div class="mb-12">
        <ProcessSteps client:load />
      </div>

      <!-- Service Stats -->
      <div class="mb-12">
        <ServiceStats service={service} client:load />
      </div>

      <!-- Service Gallery -->
      <div class="mb-12">
        <ServiceGallery serviceName={subService.ar_name} client:load />
      </div>

      <!-- Service Providers -->
      <div class="mb-12">
        <ServiceProviders serviceName={subService.ar_name} client:load />
      </div>

      <!-- Testimonials -->
      <div class="mb-12">
        <Testimonials serviceName={subService.ar_name} client:load />
      </div>

      <!-- FAQ Section -->
      {subService.seo.faq && subService.seo.faq.length > 0 && (
        <div class="mb-12">
          <FAQ faqs={subService.seo.faq} client:load />
          <FAQSchema faqs={subService.seo.faq} serviceName={subService.ar_name} />
        </div>
      )}

      <!-- CTA Section -->
      <div class="mb-12">
        <ServiceCTA 
          serviceName={subService.ar_name}
          isEmergency={subService.urgency === 'emergency'}
          priceRange={subService.avg_price_range}
          responseTime="30 دقيقة"
          variant="hero"
          client:load 
        />
      </div>

      <!-- Related Services -->
      <Card class="mb-12">
        <CardHeader>
          <CardTitle class="font-headline text-xl">خدمات أخرى في {service.ar_name}</CardTitle>
        </CardHeader>
        <CardContent>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            {service.sub_services.filter(s => s.slug !== subService.slug).map((sub) => (
              <div key={sub.id} class="flex items-center gap-3 p-3 rounded-lg border hover:bg-muted/50 transition-colors">
                <Check class="h-5 w-5 text-primary flex-shrink-0" />
                <div>
                  <a
                    href={`/services/${service.slug}/${sub.slug}`}
                    class="font-medium hover:underline hover:text-primary transition-colors"
                  >
                    {sub.ar_name}
                  </a>
                  <p class="text-sm text-muted-foreground">
                    {sub.avg_price_range[0]} - {sub.avg_price_range[1]} ريال
                  </p>
                </div>
              </div>
            ))}
          </div>
        </CardContent>
      </Card>

      <!-- City Services Section -->
      <div class="mb-12">
        <CityServices 
          serviceName={subService.ar_name}
          serviceSlug={service.slug}
          subServiceSlug={subService.slug}
          cities={getAllCities()}
          maxCities={12}
          client:load 
        />
      </div>

      <!-- Related Services -->
      <div class="text-center mb-8">
        <h2 class="font-headline text-3xl font-bold tracking-tighter mb-4">
          خدمات أخرى قد تهمك
        </h2>
        <p class="text-foreground/80">
          اكتشف المزيد من الخدمات المتاحة في منصتنا
        </p>
      </div>
      
      <ServiceGrid services={getAllServices().filter(s => s.category === service.category && s.slug !== service.slug).slice(0, 6)} />
    </div>
  </div>
</Layout>