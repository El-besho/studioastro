---
import Layout from '../../../layouts/Layout.astro';
import { getServiceBySlug, getCityBySlug, getAllServices, getAllCities } from '../../../lib/services';
import { getSEOProps, generateCanonicalUrl } from '../../../lib/seo';
import { ServiceGrid } from '../../../components/service-grid';
import { Breadcrumb } from '../../../components/semantic/breadcrumb';
import { Card, CardContent, CardDescription, CardHeader, CardTitle } from '../../../components/ui/card';
import { Badge } from '../../../components/ui/badge';
import { Check, MapPin, Star, Clock, Shield, Phone, Mail, Users, Award, TrendingUp, Zap } from 'lucide-react';
import { FAQ } from '../../../components/service/FAQ';
import { ServiceFeatures } from '../../../components/service/ServiceFeatures';
import { ProcessSteps } from '../../../components/service/ProcessSteps';
import { SubServiceGrid } from '../../../components/service/SubServiceGrid';
import { Testimonials } from '../../../components/service/Testimonials';
import { ServiceStats } from '../../../components/service/ServiceStats';
import { ServiceGallery } from '../../../components/service/ServiceGallery';
import { ServiceProviders } from '../../../components/service/ServiceProviders';
import { ServiceCTA } from '../../../components/service/ServiceCTA';
import { FAQSchema } from '../../../components/semantic/faq-schema';
import { LocalBusinessSchema } from '../../../components/semantic/local-business-schema';
import { ServiceComparison } from '../../../components/service/ServiceComparison';
import { PriceCalculator } from '../../../components/service/PriceCalculator';
import { EmergencyContact } from '../../../components/service/EmergencyContact';

export async function getStaticPaths() {
  const services = getAllServices();
  const paths = [];
  
  for (const service of services) {
    // Get all cities for this service
    const cities = getAllCities();
    for (const city of cities) {
      paths.push({
        params: { 
          service: service.slug,
          city: city.slug 
        },
        props: { 
          service, 
          city 
        },
      });
    }
  }
  
  return paths;
}

const { service, city } = Astro.props;

if (!service || !city) {
  return Astro.redirect('/404');
}

const seoProps = {
  title: `${service.ar_name} في ${city.ar_name} | إنقاذ`,
  description: `احصل على أفضل خدمات ${service.ar_name} في ${city.ar_name} من محترفين معتمدين ومتخصصين`,
  keywords: [...service.seo.primary_keywords, city.ar_name, 'خدمات منزلية', 'السعودية'],
  canonical: generateCanonicalUrl(`/services/${service.slug}/${city.slug}`)
};
---

<Layout {...seoProps}>
  <div class="container py-12 px-4 md:px-6">
    <div class="max-w-6xl mx-auto">
      <!-- Breadcrumb -->
      <Breadcrumb client:load />
      
      <!-- Service Header -->
      <div class="text-center mb-12">
        <div class="flex justify-center gap-2 mb-4">
          <Badge class="font-headline bg-primary/10 text-primary hover:bg-primary/20">
            {service.category}
          </Badge>
          <Badge variant="outline" class="flex items-center gap-1">
            <MapPin class="h-3 w-3" />
            {city.ar_name}
          </Badge>
        </div>
        <h1 class="font-headline text-4xl font-bold tracking-tighter sm:text-5xl md:text-6xl mb-4">
          {service.ar_name} في {city.ar_name}
        </h1>
        <p class="max-w-3xl mx-auto text-foreground/80 md:text-xl/relaxed">
          احصل على أفضل خدمات {service.ar_name} في {city.ar_name} من محترفين معتمدين ومتخصصين
        </p>
      </div>

      <!-- Service Overview with Enhanced Features -->
      <div class="grid grid-cols-1 lg:grid-cols-3 gap-8 mb-12">
        <!-- Main Content -->
        <div class="lg:col-span-2">
          <Card class="mb-6">
            <CardHeader>
              <CardTitle class="font-headline text-2xl">خدمات {service.ar_name} في {city.ar_name}</CardTitle>
            </CardHeader>
            <CardContent>
              <div class="prose prose-lg max-w-none">
                <p class="text-foreground/80 leading-relaxed mb-4">
                  نقدم خدمات {service.ar_name} المتخصصة في {city.ar_name} بأعلى معايير الجودة والاحترافية. 
                  فريقنا من المحترفين المعتمدين في {city.ar_name} جاهز لتقديم أفضل الحلول لاحتياجاتك.
                </p>
                <p class="text-foreground/80 leading-relaxed">
                  {service.seo.summary}
                </p>
              </div>
            </CardContent>
          </Card>

          <!-- Quick Stats -->
          <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
            <Card class="text-center">
              <CardContent class="pt-6">
                <div class="flex items-center justify-center h-12 w-12 rounded-lg bg-primary/10 text-primary mx-auto mb-2">
                  <Users class="h-6 w-6" />
                </div>
                <div class="text-2xl font-bold">500+</div>
                <div class="text-sm text-muted-foreground">عميل راضي</div>
              </CardContent>
            </Card>
            <Card class="text-center">
              <CardContent class="pt-6">
                <div class="flex items-center justify-center h-12 w-12 rounded-lg bg-primary/10 text-primary mx-auto mb-2">
                  <Award class="h-6 w-6" />
                </div>
                <div class="text-2xl font-bold">5 سنوات</div>
                <div class="text-sm text-muted-foreground">خبرة في {city.ar_name}</div>
              </CardContent>
            </Card>
            <Card class="text-center">
              <CardContent class="pt-6">
                <div class="flex items-center justify-center h-12 w-12 rounded-lg bg-primary/10 text-primary mx-auto mb-2">
                  <TrendingUp class="h-6 w-6" />
                </div>
                <div class="text-2xl font-bold">98%</div>
                <div class="text-sm text-muted-foreground">معدل الرضا</div>
              </CardContent>
            </Card>
            <Card class="text-center">
              <CardContent class="pt-6">
                <div class="flex items-center justify-center h-12 w-12 rounded-lg bg-primary/10 text-primary mx-auto mb-2">
                  <Zap class="h-6 w-6" />
                </div>
                <div class="text-2xl font-bold">30 دقيقة</div>
                <div class="text-sm text-muted-foreground">وقت الاستجابة</div>
              </CardContent>
            </Card>
          </div>
        </div>

        <!-- Sidebar -->
        <div class="space-y-6">
          <!-- Emergency Contact -->
          {service.emergency_available && (
            <EmergencyContact 
              serviceName={service.ar_name}
              cityName={city.ar_name}
              client:load 
            />
          )}

          <!-- Price Calculator -->
          <PriceCalculator 
            serviceName={service.ar_name}
            cityName={city.ar_name}
            serviceType={service.category}
            client:load 
          />

          <!-- Quick Contact -->
          <Card>
            <CardHeader>
              <CardTitle class="font-headline text-lg">تواصل معنا الآن</CardTitle>
            </CardHeader>
            <CardContent class="space-y-4">
              <div class="flex items-center gap-3">
                <div class="flex items-center justify-center h-10 w-10 rounded-lg bg-green-100 text-green-600">
                  <Phone class="h-5 w-5" />
                </div>
                <div>
                  <div class="font-semibold">اتصل بنا</div>
                  <div class="text-sm text-muted-foreground">متاح 24/7</div>
                </div>
              </div>
              <div class="flex items-center gap-3">
                <div class="flex items-center justify-center h-10 w-10 rounded-lg bg-blue-100 text-blue-600">
                  <Mail class="h-5 w-5" />
                </div>
                <div>
                  <div class="font-semibold">راسلنا</div>
                  <div class="text-sm text-muted-foreground">رد سريع مضمون</div>
                </div>
              </div>
            </CardContent>
          </Card>
        </div>
      </div>

      <!-- Service Features with City Context -->
      <ServiceFeatures service={service} city={city} client:load />

      <!-- Sub Services Grid -->
      <div class="mb-12">
        <SubServiceGrid 
          subServices={service.sub_services} 
          serviceSlug={service.slug}
          serviceName={service.ar_name}
          client:load 
        />
      </div>

      <!-- Process Steps -->
      <div class="mb-12">
        <ProcessSteps client:load />
      </div>

      <!-- Service Stats -->
      <div class="mb-12">
        <ServiceStats service={service} city={city} client:load />
      </div>

      <!-- Service Gallery -->
      <div class="mb-12">
        <ServiceGallery serviceName={service.ar_name} cityName={city.ar_name} client:load />
      </div>

      <!-- Service Providers -->
      <div class="mb-12">
        <ServiceProviders serviceName={service.ar_name} cityName={city.ar_name} client:load />
      </div>

      <!-- Testimonials -->
      <div class="mb-12">
        <Testimonials serviceName={service.ar_name} cityName={city.ar_name} client:load />
      </div>

      <!-- FAQ Section -->
      {service.seo.faq && service.seo.faq.length > 0 && (
        <div class="mb-12">
          <FAQ faqs={service.seo.faq} client:load />
          <FAQSchema faqs={service.seo.faq} serviceName={service.ar_name} />
        </div>
      )}

      <!-- CTA Section -->
      <div class="mb-12">
        <ServiceCTA 
          serviceName={service.ar_name}
          cityName={city.ar_name}
          isEmergency={service.emergency_available}
          priceRange={[100, 500]}
          responseTime="30 دقيقة"
          variant="hero"
          client:load 
        />
      </div>

      <!-- City Info -->
      <Card class="mb-12">
        <CardHeader>
          <CardTitle class="font-headline text-xl">معلومات عن {city.ar_name}</CardTitle>
        </CardHeader>
        <CardContent>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <div class="space-y-3">
              <div class="flex items-center gap-2">
                <MapPin class="h-4 w-4 text-muted-foreground" />
                <span class="text-sm">المنطقة: {city.province}</span>
              </div>
              <div class="flex items-center gap-2">
                <Star class="h-4 w-4 text-muted-foreground" />
                <span class="text-sm">عدد السكان: {city.population.toLocaleString()}</span>
              </div>
            </div>
            <div>
              <p class="text-sm text-muted-foreground">
                {city.ar_name} هي واحدة من أهم المدن في المملكة العربية السعودية، 
                وتتميز بموقعها الاستراتيجي واقتصادها المتنوع.
              </p>
            </div>
          </div>
        </CardContent>
      </Card>

      <!-- Service Comparison -->
      <div class="mb-12">
        <ServiceComparison 
          currentService={service}
          cityName={city.ar_name}
          client:load 
        />
      </div>

      <!-- Related Services -->
      <div class="text-center mb-8">
        <h2 class="font-headline text-3xl font-bold tracking-tighter mb-4">
          خدمات أخرى في {city.ar_name}
        </h2>
        <p class="text-foreground/80">
          اكتشف المزيد من الخدمات المتاحة في {city.ar_name}
        </p>
      </div>
      
      <ServiceGrid services={getAllServices().filter(s => s.category === service.category && s.slug !== service.slug).slice(0, 6)} />

      <!-- Local Business Schema -->
      <LocalBusinessSchema 
        serviceName={service.ar_name}
        cityName={city.ar_name}
        serviceType={service.category}
        phoneNumber="+966500000000"
        address={`${city.ar_name}, المملكة العربية السعودية`}
        rating={4.8}
        reviewCount={127}
        priceRange="ريال"
        openingHours="24/7"
      />
    </div>
  </div>
</Layout>