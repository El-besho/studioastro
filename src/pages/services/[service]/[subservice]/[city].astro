---
import Layout from '../../../../layouts/Layout.astro';
import { getServiceAndSubServiceBySlugs, getCityBySlug, getAllServices, getAllCities } from '../../../../lib/services';
import { getSEOProps, generateCanonicalUrl } from '../../../../lib/seo';
import { ServiceGrid } from '../../../../components/service-grid';
import { Breadcrumb } from '../../../../components/semantic/breadcrumb';
import { Card, CardContent, CardDescription, CardHeader, CardTitle } from '../../../../components/ui/card';
import { Badge } from '../../../../components/ui/badge';
import { Check, MapPin, Star, Clock, Shield, Phone, Mail } from 'lucide-react';
import { Testimonials } from '../../../../components/service/Testimonials';
import { ServiceStats } from '../../../../components/service/ServiceStats';
import { ServiceGallery } from '../../../../components/service/ServiceGallery';
import { ServiceProviders } from '../../../../components/service/ServiceProviders';
import { ServiceCTA } from '../../../../components/service/ServiceCTA';
import { FAQSchema } from '../../../../components/semantic/faq-schema';

export async function getStaticPaths() {
  const services = getAllServices();
  const paths = [];
  
  for (const service of services) {
    for (const subService of service.sub_services) {
      // Get all cities for this sub-service
      const cities = getAllCities();
      for (const city of cities) {
        paths.push({
          params: { 
            service: service.slug,
            subservice: subService.slug,
            city: city.slug 
          },
          props: { 
            service, 
            subService,
            city 
          },
        });
      }
    }
  }
  
  return paths;
}

const { service, subService, city } = Astro.props;

if (!service || !subService || !city) {
  return Astro.redirect('/404');
}

const seoProps = {
  title: `${subService.ar_name} في ${city.ar_name} | ${service.ar_name}`,
  description: `احصل على أفضل خدمات ${subService.ar_name} في ${city.ar_name} من محترفين معتمدين ومتخصصين في ${service.ar_name}`,
  keywords: [...subService.seo.primary_keywords, service.ar_name, city.ar_name, 'خدمات منزلية', 'السعودية'],
  canonical: generateCanonicalUrl(`/services/${service.slug}/${subService.slug}/${city.slug}`)
};
---

<Layout {...seoProps}>
  <div class="container py-12 px-4 md:px-6">
    <div class="max-w-6xl mx-auto">
      <!-- Breadcrumb -->
      <Breadcrumb client:load />
      
      <!-- Service Header -->
      <div class="text-center mb-12">
        <div class="flex justify-center gap-2 mb-4">
          <Badge class="font-headline bg-primary/10 text-primary hover:bg-primary/20">
            {service.category}
          </Badge>
          <Badge variant="outline" class="flex items-center gap-1">
            <MapPin class="h-3 w-3" />
            {city.ar_name}
          </Badge>
        </div>
        <h1 class="font-headline text-4xl font-bold tracking-tighter sm:text-5xl md:text-6xl mb-4">
          {subService.ar_name} في {city.ar_name}
        </h1>
        <p class="max-w-3xl mx-auto text-foreground/80 md:text-xl/relaxed">
          احصل على أفضل خدمات {subService.ar_name} في {city.ar_name} من محترفين معتمدين ومتخصصين
        </p>
      </div>

      <!-- Service Details -->
      <div class="grid grid-cols-1 lg:grid-cols-3 gap-8 mb-12">
        <!-- Main Content -->
        <div class="lg:col-span-2 space-y-6">
          <!-- Service Overview -->
          <Card>
            <CardHeader>
              <CardTitle class="font-headline text-2xl">خدمات {subService.ar_name} في {city.ar_name}</CardTitle>
            </CardHeader>
            <CardContent>
              <div class="prose prose-lg max-w-none">
                <p class="text-foreground/80 leading-relaxed mb-4">
                  نقدم خدمات {subService.ar_name} المتخصصة في {city.ar_name} بأعلى معايير الجودة والاحترافية. 
                  فريقنا من المحترفين المعتمدين في {city.ar_name} جاهز لتقديم أفضل الحلول لاحتياجاتك.
                </p>
                <p class="text-foreground/80 leading-relaxed">
                  {subService.description || `خدمات ${subService.ar_name} في ${city.ar_name} تشمل جميع المتطلبات الأساسية والاحترافية لضمان رضاكم التام.`}
                </p>
              </div>
            </CardContent>
          </Card>

          <!-- Features -->
          <Card>
            <CardHeader>
              <CardTitle class="font-headline text-xl">مميزات الخدمة في {city.ar_name}</CardTitle>
            </CardHeader>
            <CardContent>
              <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div class="flex items-center gap-3">
                  <div class="flex items-center justify-center h-10 w-10 rounded-lg bg-primary/10 text-primary">
                    <MapPin class="h-5 w-5" />
                  </div>
                  <div>
                    <h4 class="font-semibold">محليون في {city.ar_name}</h4>
                    <p class="text-sm text-muted-foreground">فريق محلي متخصص</p>
                  </div>
                </div>
                <div class="flex items-center gap-3">
                  <div class="flex items-center justify-center h-10 w-10 rounded-lg bg-primary/10 text-primary">
                    <Star class="h-5 w-5" />
                  </div>
                  <div>
                    <h4 class="font-semibold">جودة عالية</h4>
                    <p class="text-sm text-muted-foreground">أعلى معايير الجودة</p>
                  </div>
                </div>
                <div class="flex items-center gap-3">
                  <div class="flex items-center justify-center h-10 w-10 rounded-lg bg-primary/10 text-primary">
                    <Clock class="h-5 w-5" />
                  </div>
                  <div>
                    <h4 class="font-semibold">سرعة في التنفيذ</h4>
                    <p class="text-sm text-muted-foreground">تنفيذ سريع ومضمون</p>
                  </div>
                </div>
                <div class="flex items-center gap-3">
                  <div class="flex items-center justify-center h-10 w-10 rounded-lg bg-primary/10 text-primary">
                    <Shield class="h-5 w-5" />
                  </div>
                  <div>
                    <h4 class="font-semibold">ضمان الجودة</h4>
                    <p class="text-sm text-muted-foreground">ضمان شامل على الخدمة</p>
                  </div>
                </div>
              </div>
            </CardContent>
          </Card>

          <!-- Process -->
          <Card>
            <CardHeader>
              <CardTitle class="font-headline text-xl">كيف نحصل على الخدمة؟</CardTitle>
            </CardHeader>
            <CardContent>
              <div class="space-y-4">
                <div class="flex items-start gap-4">
                  <div class="flex items-center justify-center h-8 w-8 rounded-full bg-primary text-primary-foreground text-sm font-bold">1</div>
                  <div>
                    <h4 class="font-semibold">تواصل معنا</h4>
                    <p class="text-sm text-muted-foreground">اتصل بنا أو املأ النموذج للحصول على عرض سعر مجاني</p>
                  </div>
                </div>
                <div class="flex items-start gap-4">
                  <div class="flex items-center justify-center h-8 w-8 rounded-full bg-primary text-primary-foreground text-sm font-bold">2</div>
                  <div>
                    <h4 class="font-semibold">تقييم الموقع</h4>
                    <p class="text-sm text-muted-foreground">نقوم بتقييم موقعك في {city.ar_name} وتحديد المتطلبات</p>
                  </div>
                </div>
                <div class="flex items-start gap-4">
                  <div class="flex items-center justify-center h-8 w-8 rounded-full bg-primary text-primary-foreground text-sm font-bold">3</div>
                  <div>
                    <h4 class="font-semibold">تنفيذ الخدمة</h4>
                    <p class="text-sm text-muted-foreground">نقوم بتنفيذ {subService.ar_name} بأعلى معايير الجودة</p>
                  </div>
                </div>
                <div class="flex items-start gap-4">
                  <div class="flex items-center justify-center h-8 w-8 rounded-full bg-primary text-primary-foreground text-sm font-bold">4</div>
                  <div>
                    <h4 class="font-semibold">ضمان الجودة</h4>
                    <p class="text-sm text-muted-foreground">نضمن جودة العمل ونقدم خدمة ما بعد البيع</p>
                  </div>
                </div>
              </div>
            </CardContent>
          </Card>
        </div>

        <!-- Sidebar -->
        <div class="space-y-6">
          <!-- CTA -->
          <ServiceCTA 
            serviceName={subService.ar_name}
            cityName={city.ar_name}
            isEmergency={subService.urgency === 'emergency'}
            priceRange={subService.avg_price_range}
            responseTime="30 دقيقة"
            variant="compact"
            client:load 
          />

          <!-- City Info -->
          <Card>
            <CardHeader>
              <CardTitle class="font-headline text-lg">معلومات عن {city.ar_name}</CardTitle>
            </CardHeader>
            <CardContent>
              <div class="space-y-3">
                <div class="flex items-center gap-2">
                  <MapPin class="h-4 w-4 text-muted-foreground" />
                  <span class="text-sm">المنطقة: {city.region}</span>
                </div>
                <div class="flex items-center gap-2">
                  <Star class="h-4 w-4 text-muted-foreground" />
                  <span class="text-sm">عدد السكان: {city.population}</span>
                </div>
                <p class="text-sm text-muted-foreground">
                  {city.description}
                </p>
              </div>
            </CardContent>
          </Card>

          <!-- Related Services -->
          <Card>
            <CardHeader>
              <CardTitle class="font-headline text-lg">خدمات أخرى في {city.ar_name}</CardTitle>
            </CardHeader>
            <CardContent>
              <ul class="space-y-3">
                {service.sub_services.filter(s => s.slug !== subService.slug).slice(0, 5).map((sub) => (
                  <li key={sub.id} class="flex items-center gap-3">
                    <Check class="h-4 w-4 text-primary flex-shrink-0" />
                    <a
                      href={`/services/${service.slug}/${sub.slug}/${city.slug}`}
                      class="text-sm hover:underline hover:text-primary transition-colors"
                    >
                      {sub.ar_name}
                    </a>
                  </li>
                ))}
              </ul>
            </CardContent>
          </Card>
        </div>
      </div>

      <!-- Service Stats -->
      <div class="mb-12">
        <ServiceStats service={service} city={city} client:load />
      </div>

      <!-- Service Gallery -->
      <div class="mb-12">
        <ServiceGallery serviceName={subService.ar_name} cityName={city.ar_name} client:load />
      </div>

      <!-- Service Providers -->
      <div class="mb-12">
        <ServiceProviders serviceName={subService.ar_name} cityName={city.ar_name} client:load />
      </div>

      <!-- Testimonials -->
      <div class="mb-12">
        <Testimonials serviceName={subService.ar_name} cityName={city.ar_name} client:load />
      </div>

      <!-- FAQ Section -->
      {subService.seo.faq && subService.seo.faq.length > 0 && (
        <div class="mb-12">
          <FAQSchema faqs={subService.seo.faq} serviceName={subService.ar_name} />
        </div>
      )}

      <!-- CTA Section -->
      <div class="mb-12">
        <ServiceCTA 
          serviceName={subService.ar_name}
          cityName={city.ar_name}
          isEmergency={subService.urgency === 'emergency'}
          priceRange={subService.avg_price_range}
          responseTime="30 دقيقة"
          variant="hero"
          client:load 
        />
      </div>

      <!-- Related Services -->
      <div class="text-center mb-8">
        <h2 class="font-headline text-3xl font-bold tracking-tighter mb-4">
          خدمات أخرى في {city.ar_name}
        </h2>
        <p class="text-foreground/80">
          اكتشف المزيد من الخدمات المتاحة في {city.ar_name}
        </p>
      </div>
      
      <ServiceGrid services={getAllServices().filter(s => s.category === service.category && s.slug !== service.slug).slice(0, 6)} />
    </div>
  </div>
</Layout>