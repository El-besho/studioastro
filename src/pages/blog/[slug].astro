---
import Layout from '../../layouts/Layout.astro';
import { getPostBySlug, getAllPosts } from '../../lib/blog';
import { getSEOProps, generateCanonicalUrl } from '../../lib/seo';
import { Card, CardContent, CardDescription, CardHeader, CardTitle } from '../../components/ui/card';
import { Badge } from '../../components/ui/badge';
import { Calendar, User, Tag, ArrowLeft } from 'lucide-react';
import { Breadcrumb } from '../../components/semantic/breadcrumb';
import { TableOfContents } from '../../components/blog/TableOfContents';
import { RelatedPosts } from '../../components/blog/RelatedPosts';
import { BlogPostMeta } from '../../components/blog/BlogPostMeta';

export async function getStaticPaths() {
  const posts = await getAllPosts();
  return posts.map((post) => ({
    params: { slug: post.slug },
    props: { post, allPosts: posts },
  }));
}

const { post, allPosts } = Astro.props;

if (!post) {
  return Astro.redirect('/404');
}

const seoProps = {
  title: `${post.frontmatter.title} | إنقاذ`,
  description: post.frontmatter.summary,
  keywords: [...post.frontmatter.tags, 'مدونة', 'مقالات', 'نصائح', 'خدمات منزلية'],
  canonical: generateCanonicalUrl(`/blog/${post.slug}`)
};
---

<Layout {...seoProps}>
  <div class="container py-12 px-4 md:px-6">
    <div class="max-w-7xl mx-auto">
      <!-- Breadcrumb -->
      <Breadcrumb client:load />
      
      <!-- Back Button -->
      <div class="mb-6">
        <a 
          href="/blog" 
          class="inline-flex items-center text-sm font-medium text-primary hover:underline"
        >
          <ArrowLeft class="h-4 w-4 mr-2" />
          العودة إلى المدونة
        </a>
      </div>

      <!-- Article Header -->
      <div class="text-center mb-12">
        <div class="flex items-center justify-center gap-4 text-sm text-muted-foreground mb-4">
          <div class="flex items-center gap-2">
            <Calendar class="h-4 w-4" />
            <span>{new Date(post.frontmatter.date).toLocaleDateString('ar-SA')}</span>
          </div>
          <div class="flex items-center gap-2">
            <User class="h-4 w-4" />
            <span>{post.frontmatter.author}</span>
          </div>
        </div>
        
        <h1 class="font-headline text-4xl font-bold tracking-tighter sm:text-5xl md:text-6xl mb-6">
          {post.frontmatter.title}
        </h1>
        
        <p class="max-w-3xl mx-auto text-foreground/80 md:text-xl/relaxed mb-6">
          {post.frontmatter.summary}
        </p>

        <div class="flex flex-wrap justify-center gap-2">
          {post.frontmatter.tags.map((tag) => (
            <Badge variant="secondary">
              <Tag class="h-3 w-3 mr-1" />
              {tag}
            </Badge>
          ))}
        </div>
      </div>

      <!-- Main Content Layout -->
      <div class="grid grid-cols-1 lg:grid-cols-4 gap-8">
        <!-- Table of Contents (Sidebar) -->
        <div class="lg:col-span-1 order-2 lg:order-1">
          <TableOfContents headings={post.frontmatter.headings || []} client:load />
        </div>

        <!-- Article Content -->
        <div class="lg:col-span-3 order-1 lg:order-2">
          <!-- Post Meta -->
          <BlogPostMeta post={post} class="mb-8" client:load />

          <!-- Article Content -->
          <Card class="mb-8">
            <CardContent class="pt-8">
              <div class="prose prose-lg max-w-none prose-headings:font-headline prose-headings:text-foreground prose-p:text-foreground/80 prose-a:text-primary prose-strong:text-foreground prose-headings:scroll-mt-24">
                <div set:html={post.content} />
              </div>
            </CardContent>
          </Card>

          <!-- Related Posts -->
          <RelatedPosts currentPost={post} allPosts={allPosts} class="mb-12" client:load />

          <!-- CTA -->
          <Card class="bg-primary/5 border-primary/20">
            <CardContent class="pt-6 text-center">
              <h3 class="font-headline text-lg font-semibold mb-2">هل تحتاج إلى مساعدة؟</h3>
              <p class="text-sm text-muted-foreground mb-4">
                تواصل معنا للحصول على أفضل الخدمات المنزلية في السعودية
              </p>
              <a
                href="/contact"
                class="inline-flex items-center justify-center rounded-md text-sm font-medium ring-offset-background transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 bg-primary text-primary-foreground hover:bg-primary/90 h-10 px-4 py-2"
              >
                تواصل معنا
              </a>
            </CardContent>
          </Card>
        </div>
      </div>
    </div>
  </div>
</Layout>